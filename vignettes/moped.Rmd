---
title: "moped"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{moped}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
#library(moped)
```

# `moped`: Multivariate Orthogonal Polynomial-based Estimation of Density

The `moped` package applies the multivariate moment-based density estimation method outlined in Wakefield et. al. (2022) . The purpose of this package is to implement orthogonal polynomial-based joint density estimation to multivariate continuous sample data, obtain density and probability estimates from both the "complete" joint distribution and all marginal distribution estimates, and simulate "synthetic" sample data from said density estimates. The package has considerable use cases in density-based imputation for missing data, robust non-parametric density estimation on aggregated data, and to produce anonymised "synthetic" representative data for the purposes of public dissemination in place of confidential micro-data. Orthogonal polynomial-based density estimation has also been shown to have applications previously in areas such as engineering, physics, and finance \citep{Munkhammar2017}.

In the following report, we lay out some of the important features of the `moped` package and provide examples of code usage that may assist in the further application of these density estimates.

## Estimating Joint Densities with `moped` on Continuous Sample Data

The theoretical results underpinning the sample moment-based density estimate implemented in `moped` can be found in Wakefield et. al. (2022). We note that to avoid word encumbered, we will refer to the "multivariate sample moment-based density estimate" described in Wakefield et. al. (2022) as simply the "moped estimate". We provide a brief summary of the results outlined in Wakefield et. al. (2022) in the following section.

### The mathematical underpinnings of the moped estimate.

The moped estimate is constructed of a few fundamental components: (i) the reference distribution, (ii) the multivariate hyper-geometric type polynomials, (iii) the sample moment-based coefficient estimates, and (iv) the maximum polynomial order ($K$) of the estimate. We will look at each of these components in the following sections

### The reference distribution.

To obtain a moped estimate of the continuous random vector $\mathbf{X}=(X_1,X_2,\dots,X_N)$ of dimension $N$, a "reference" distribution for each $k$th random variable $X_k$ is needed to be specified. The reference distribution of random vector $\nu = (\nu_1,\nu_2,\dots,\nu_N)$ serves as the initial basis of the moped estimate and has reference density $f_{\nu} = \prod_{k=1}^N f_{\nu_k}$ where $f_{\nu_k}$ is the density of each $\nu_k$. We require that for each $k$th variable, the sample space of $X_k$ denoted $\Omega_k=[a_k,b_k]$ is also the sample space of $\nu_k$ (i.e. $\nu_k \in \Omega_k$), and $\{\nu_k\}_{k=1,2,\dots,N}$ are mutually independent. We also require that the joint density function $f_{\mathbf{X}} :\mathbb{R}^N \rightarrow\mathbb{R}$ of the random vector $\mathbf{X}$ is defined on the product space $\Omega^{(N)}=\prod_{k=1}^N\Omega_k = \prod_{k=1}^N[a_k,b_k]$. We note that the random vector $\nu$ has sample space $\Omega^{(N)}$.

We require that for each $f_{\nu_k}$ there exists polynomial functions $\sigma_k(x) = \phi_{k,2}x^2 + \phi_{k,1}x + \phi_{k,0}$ and $\tau_k(x) = \psi_{k,1}x + \psi_{k,0}$ of degree 2 and 1 respectively such that,

$$
\frac{d}{dx}\left[ \sigma_{k}(x)f_{\nu_k}(x)\right] = \tau_k(x)f_{\nu_k}(x) \tag{1}
$$

with boundary conditions, for $i=0,1,\dots$

$$
\lim_{x\rightarrow a_k} x^i\sigma_k(x)f_{\nu_k}(x) = \lim_{x\rightarrow b_k} x^i\sigma_k(x)f_{\nu_k}(x)= 0.
$$

Note these properties were outlined in \cite{Sanchez1997}.

Common examples of reference distributions that can be used in the moped estimate are given in the table below. Note, all of the reference distributions listed below can be applied in the `moped` package.

+------------------------+-----------------------------------------------------------------+------------------+-------------------------------+-----------+----------+
| **Distribution**       | $f_{\nu_k}$                                                     | $\sigma_{\nu_k}$ | $\tau_{\nu_k}$                | $a_k$     | $b_k$    |
+========================+=================================================================+==================+===============================+===========+==========+
| Normal $(m, s)$        | $\frac{1}{\sqrt{2 \pi s^2 }}e^{- \frac{(x-m)^2}{2 s^2}}$        | $-s^2$           | $x-m$                         | $-\infty$ | $\infty$ |
+------------------------+-----------------------------------------------------------------+------------------+-------------------------------+-----------+----------+
| Gamma $(\alpha,\beta)$ | $\frac{\beta^{\alpha}}{\Gamma(\alpha)}x^{\alpha-1}e^{-\beta x}$ | $x$              | $\alpha - \beta x$            | $0$       | $\infty$ |
+------------------------+-----------------------------------------------------------------+------------------+-------------------------------+-----------+----------+
| Uniform $(u,v)$        | $\frac{1}{v-u}$                                                 | $(x-u)(x-v)$     | $2x -(u+v)$                   | $u$       | $v$      |
+------------------------+-----------------------------------------------------------------+------------------+-------------------------------+-----------+----------+
| Beta $(\alpha,\beta)$  | $\frac{x^{\alpha - 1}(1-x)^{\beta - 1}}{B(\alpha,\beta)}$       | $x(1-x)$         | $-(\alpha + \beta)x + \alpha$ | 0         | 1        |
+------------------------+-----------------------------------------------------------------+------------------+-------------------------------+-----------+----------+

### The multivariate hyper-geometric type polynomials.

The marginal hyper-geometric type polynomials for each reference distribution $\nu_k$ follow from the Sturm-Louisville differential equation expressed in (1).

Essentially, given there exists a reference density $f_{\nu_k}$ that meets the requirements of our reference density, then there exists polynomials, $\{P_{k,n_k}(x_k)\}_{n_k = 0,1,2,\dots}$ which are eigenfunction solutions to the differential equation

$$
\sigma_{k}(x_k)P_{k,n_k}''(x_k)+\tau_{k,n_k}(x_k)P_{k,n_k}'(x_k) - \lambda_{k,n_k}P_{k,n_k}(x_k) = 0
$$

with eigenvalues $\lambda_{k,n_k}= n\psi_{k,1}+\frac{1}{2}n(n-1)\phi_{k,2}$.

The marginal hyper-geometric type polynomials $\{P_{k,n_k}(x_k)\}_{n_k = 0,1,2,\dots}$ are polynomials of degree $n_k$ of the form,

$$
P_{k,n_k}(x_k) = \frac{B_{k,n_k}}{f_{\nu_k}(x_k)}\frac{d^{n_k}}{dx_k^{n_k}}\left[(\sigma_k(x_k))^{n_k}f_{\nu_k}(x_k)\right]
$$

which when we take the value of $B_{k,n_k}$ as follows,

$$
 B_{k,0} = 1, \qquad B_{k,n_k} = \sqrt{ \frac{(-1)^{n_k} \prod_{i_k=0}^{n_k-1} \left[\frac{1}{ \psi_{k,1} + \frac{1}{2}(n_k + i_k -1)\phi_{k,2}}\right] }{ n_k! \int_{a_k}^{b_k} (\sigma_k(t))^{n_k}f_{\nu_k}(t) dt}, } \quad \text{ for } n_k = 1,2,\dots, 
$$

are orthonormal with respect to the reference density $f_{\nu_k}$, i.e.

$$ 
\int_{\Omega_k}P_{k,n_k}(x_k)P_{k,m_k}(x_k)f_{\nu_k}(x_k)dx_k = \delta_{n_k=m_k}
$$

where $\delta_{n_k=m_k}$ is the Kronecker delta and is 1 when $n_k=m_k$ and 0 otherwise.

We note that each polynomial can be expressed as $P_{k,n_k}(x_k) = \sum_{i_k=0}^{n_k}a_{n_k,i_k}x^{i_k}$, where the coefficients $a_{n_k,i_k}$ are given by,

$$
a_{n_k,i_k} =
\begin{cases}
 \frac{a_{n_k,i_k+1}(i_k + 1)(i_k \phi_{k,1} + \psi_{k,0}) + a_{n_k,i_k+2}(i_k +2)(i_k + 1)\phi_{k,0}}{\lambda_{k,n_k} - \frac{1}{2}i_k(i_k - 1)\phi_{k,2} - i_k\psi_{k,1}}, & i_k = 0,\dots,n_k-2 \\
 \kappa_{k,n_k} \frac{n_k (n_k -1)\phi_{k,1} + n_k \psi_{k,0}}{ \psi_{k,1} + (n_k - 1)\phi_{k,2}}, & i_k = n_k-1\\
  \kappa_{k,n_k},  & i_k = n_k
\end{cases},
$$

where $\kappa_{k,n_k} = B_{k,n_k} \prod_{i_k=0}^{n_k-1} \left[ \psi_{k,1} + \frac{1}{2}(n_k + i_k -1)\phi_{k,2} \right]$ and $\kappa_{k,0} =1$. 

We define the **multivariate** **hyper-geometric type polynomials** as being the product of the marginal hyper-geometric type polynomials across the $N$ dimensions, i.e.,

$$
P_{n_1,\dots,n_N}(\mathbf{x}) = \prod_{k=1}^NP_{k,n_k}(x_k), \quad \text{where } \mathbf{x}=(x_1,x_2,\dots,x_N).
$$

As shown in Wakefield et. al. (2022), the multivariate hyper-geometric type polynomials are orthonormal in $\Omega^{(N)}$ with respect to the reference density $f_{\nu}$, i.e.,

$$
\int_{\Omega^{(N)}} P_{n_1,\dots,n_N}(\mathbf{x})P_{m_1,\dots,m_N}(\mathbf{x})f_{\nu}(\mathbf{x})d\mathbf{x} = \prod_{k=1}^N\delta_{n_k=m_k},
$$

where $\delta_{n_k=m_k}$ is the Kronecker delta that is 1 when $n_k=m_k$ and 0 otherwise.

The multivariate polynomials also serve as basis functions for approximation of multivariate continuous functions defined on $\Omega^{(N)}$.

### The sample moment-based coefficient estimates.

### The maximum polynomial order ($K$) of the moped estimate.

## Notation Glossary

The following notation will be used as standard throughout the following sections of the vignette.

+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Notation                                                    | Index                                            | Description                                                                                                                                                                                                                                                                           | Property                                                                                                                                                                                                                                                                                                                                                                               |
+=============================================================+==================================================+=======================================================================================================================================================================================================================================================================================+========================================================================================================================================================================================================================================================================================================================================================================================+
| $N$                                                         |                                                  | Number of variables being estimated.                                                                                                                                                                                                                                                  |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\mathbf{X} = (X_1,X_2,\dots,X_N)$                          |                                                  | Random vector of $N$ random variables to be estimated.                                                                                                                                                                                                                                |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\Omega^{(N)}$                                              |                                                  | N-dimensional sample space of $\mathbf{X}$.                                                                                                                                                                                                                                           |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $f_{\mathbf{X}}(\mathbf{x})$                                | $\mathbf{X} = (X_1,X_2,\dots,X_N)$               | The true $N$-dimensional joint density function of $\mathbf{X}$.                                                                                                                                                                                                                      | $f_{\mathbf{X}}:\Omega^{(N)} \rightarrow [0,1]$                                                                                                                                                                                                                                                                                                                                        |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $\mathbf{x} = (x_1,x_2,\dots,x_N)$               |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\Omega_k =[a_k,b_k]$                                       | $k=1,\dots,N$                                    | Lower bounds ($a_k$) and upper bounds ($b_k$) of each $k$th element of $\mathbf{X}$.                                                                                                                                                                                                  | $\Omega^{(N)} = \prod_{k=1}^N \Omega_k= \prod_{k=1}^N [a_k,b_k]$                                                                                                                                                                                                                                                                                                                       |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $f_\nu(\mathbf{x})$                                         | $\nu = (\nu_1,\nu_2,\dots,\nu_N)$,               | $N$-dimensional "reference" density corresponding to the orthogonality weight function of the multivariate orthogonal polynomials.                                                                                                                                                    | $f_{\nu}:\Omega^{(N)} \rightarrow [0,1]$                                                                                                                                                                                                                                                                                                                                               |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $\mathbf{x} = (x_1,x_2,\dots,x_N)$               |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $f_{\nu_k}(x_k)$                                            | $k=1,\dots,N$                                    | The $k$th "reference" density related to the orthogonality weight function of the $k$th marginal orthogonal polynomial.                                                                                                                                                               | $f_{\nu_k}:\Omega_k \rightarrow [0,1]$,                                                                                                                                                                                                                                                                                                                                                |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       | $f_\nu(\mathbf{x}) = \prod_{k=1}^Nf_{\nu_k}(x_k)$.                                                                                                                                                                                                                                                                                                                                     |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\sigma_k(x_k)$                                             | $k=1,\dots,N$                                    | Quadratic polynomial corresponding to each $k$th reference density. Appears in the Sturm-Louisville differential equation of the polynomials.                                                                                                                                         |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\tau_k(x_k)$                                               | $k=1,\dots,N$                                    | Linear polynomial corresponding to each $k$th reference density. Appears in the Sturm-Louisville differential equation of the polynomials.                                                                                                                                            |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\lambda_{k,n_k}$                                           | $k=1,\dots,N$,                                   | Eigenvalues corresponding to the $n_k$th eigenfunction solution of the Sturm-Louisville differential equation of the polynomials for each $k$th reference density.                                                                                                                    |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $n_k=0,1,2, \dots$                               |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $P_{n_1,\dots,n_N}(\mathbf{x})$                             | $\mathbf{x} = (x_1,x_2,\dots,x_N)$               | The $n_1,n_2,\dots,n_N$ order multivariate hyper-geometric type orthogonal polynomial corresponding to the reference density $f_{\nu}(\mathbf{x})$.                                                                                                                                   | $\int_{\Omega^{(N)}} P_{n_1,\dots,n_N}(\mathbf{x})P_{m_1,\dots,m_N}(\mathbf{x})f_{\nu}(\mathbf{x})d\mathbf{x} = \prod_{k=1}^N\delta_{n_k=m_k}$                                                                                                                                                                                                                                         |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $n_1 = 0, 1, 2, \dots$                           |                                                                                                                                                                                                                                                                                       | where $\delta_{n_k=m_k}$ is the Kronecker delta that is 1 when $n_k=m_k$ and 0 otherwise.                                                                                                                                                                                                                                                                                              |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $n_2 = 0,1,2,\dots$                              |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $\vdots$                                         |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $n_N = 0,1,2,\dots$                              |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $P_{k,n_k}(x_k) = \sum_{i_k=0}^{n_k}a_{k,n_k,i_k}x_k^{i_k}$ | $k=1,2,\dots,N$                                  | The $n_k$th order $k$th marginal hyper-geometric type orthogonal polynomial corresponding to the marginal reference density $f_{\nu_k}(x_k)$. The constants $a_{k,n_k,i_k}$ denote the coefficient $i_k$th term in the $n_k$th order polynomial corresponding to the $k$th variable . | $\int_{\Omega_k}P_{k,n_k}(x_k)P_{k,m_k}(x_k)f_{\nu_k}(x_k)dx_k = \delta_{n_k=m_k}$ where $\delta_{n_k=m_k}$ is the Kronecker delta that is 1 when $n_k=m_k$ and 0 otherwise.                                                                                                                                                                                                           |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $n_k = 0,1,2,\dots$                              |                                                                                                                                                                                                                                                                                       | $P_{n_1,\dots,n_N}(\mathbf{x}) = \prod_{k=1}^NP_{k,n_k}(x_k)$.                                                                                                                                                                                                                                                                                                                         |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $i_k = 0,1,2,\dots,n_k$                          |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $M$                                                         |                                                  | Size of a random sample.                                                                                                                                                                                                                                                              |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| $\{\mathbf{x}_j\}_{j=1}^M$                                  | $j=1,2,\dots,M$                                  | Random sample of size $M$ with each $j$th observation a random vector $\mathbf{X}_j$ with joint density function $f_{\mathbf{X}}(\mathbf{x})$.                                                                                                                                        | Note: For consistency in notation, all random variables are expressed with capital letters. As the results in this report are focused on the definition of a density estimator, it makes more sense to express each observation as a random vector each with joint density function $f_{\mathbf{X}}(\mathbf{x})$ rather than as "realisations" of a single random vector $\mathbf{X}$. |
|                                                             |                                                  |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
|                                                             | $\mathbf{X}_j = (X_{1,j},X_{2,j},\dots,X_{N,j})$ |                                                                                                                                                                                                                                                                                       |                                                                                                                                                                                                                                                                                                                                                                                        |
+-------------------------------------------------------------+--------------------------------------------------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+

```{r}

```
